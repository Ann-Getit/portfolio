<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>


     <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
        crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
        crossorigin=""></script>

    <script src="https://code.jquery.com/jquery-3.7.1.js"></script>

    <link rel="stylesheet" href="landkaart.css">


    <style>
    
        #map {
            height: 500px;
        }

        button {
            background-color: pink;
            margin: 10px;
            cursor: pointer;
        }
        button:hover {
            background-color: rgb(209, 139, 151);
            color: whitesmoke;
        }


    </style>

    <script>
            //Globale variabele: mop kan ik alle functies gebruiken worden

        var map;


        function initialize()
        { //scope: mapobject word zichtbaar.
         map = L.map('map').setView([52.38020147295795, 4.892925143214285], 7);

         //openstreetmap word
        L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
         attribution: 'AET 2025'
         }).addTo(map);

        L.marker([52.38020147295795, 4.892925143214285]).addTo(map)
         .bindPopup('stad van Nederland')
         .openPopup();

         L.marker([35.7198981319163, 139.7351590127453]).addTo(map).bindPopup('Tokyo'); //de coordinatoren vind je terug op google map. click de plek en dan rechter klik.

         L.marker([52.06275232036461, 4.297458493109473]).addTo(map).bindPopup('Den haag');
        }

        function flyToTokyo()
        {
            map.flyTo([35.7198981319163, 139.7351590127453], 15);
        }

        function flyToAmsterdam()
        {
            var amsterdam = [52.3676, 4.9041]; // Latitude, Longitude
             map.flyTo(amsterdam, 15); // 15 = zoom level
        }



        function getStations() {

            $.getJSON("/api/stations", showStations);  //de parameter van showStation is waar de simplified staat als (data)
        }

// Haal vertrektijden voor één station. UICCode is de code van het station bijv AMS
async function getDepartures(UICCode) {
    try {
        const vertrektijden = await fetch(`/api/vertrektijden?station=${UICCode}`)
        .then(res => res.json());// van json naar js  formaat
        console.log(vertrektijden);
        return vertrektijden; // array van vertrektijden. vertrektijden
    } catch (err) {
        console.error("Fout bij ophalen vertrektijden:", err);
        return [];
    }
    
} // dit doet het goed!

//de NS API geeft tijden zo: 2026-02-08T21:24:00+01:00. dit maakt ze: 12:23 :
function formatTime(dateString) {
    if (!dateString) return "?";

    const d = new Date(dateString);
    return d.toLocaleTimeString('nl-NL', {
        hour: '2-digit',
        minute: '2-digit'
    });
}


// Stations tekenen op de kaart. //(data) hier is de simplified.
function showStations(data) {
    console.log(Array.isArray(data));
    console.log(data[0]);
    for (const st of data) {
        const circle = L.circle([st.lat, st.lng], { radius: 500 })
            .addTo(map)
            .bindPopup(`<strong>${st.name}</strong><br>Klik voor vertrektijden`);

        // Klik op circle → vertrektijden fetchen en popup updaten
        circle.on('click', async () => {
            const vertrektijden = await getDepartures(st.UICCode);

            const popupContent = vertrektijden.length
                ? vertrektijden.slice(0,3).map(t => {

                return `${formatTime(t.plannedDateTime)} →  ${t.direction} (spoor ${t.actualTrack ?? "?"})`;
              }).join("<br>")
                : "Geen vertrektijden beschikbaar";

            circle.bindPopup(`
            <div class="container"><strong>${st.name}</strong></div>
            <div class="container2">${popupContent}</div>
            `)
             .openPopup();
        });
    }
}



    </script>
</head>
<body onload="initialize()">


    <h1>landkaart</h1>

    <div id="map"></div>

    <button onclick="flyToTokyo()">Tokyo</button>

    <button onclick="flyToAmsterdam()">Vlieg naar Amsterdam</button>

    <button onclick="getStations()">Treinstations</button>


    
</body>
</html>



