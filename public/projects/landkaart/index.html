<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>


     <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
        crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
        crossorigin=""></script>

    <script src="https://code.jquery.com/jquery-3.7.1.js"></script>

    <link rel="stylesheet" href="landkaart.css">


    <style>
    
        #map {
            height: 500px;
        }

        button {
            background-color: pink;
            margin: 10px;
            cursor: pointer;
        }
        button:hover {
            background-color: rgb(209, 139, 151);
            color: whitesmoke;
        }


    </style>

    <script>
            //Globale variabele: mop kan ik alle functies gebruiken worden

        var map;


        function initialize()
        { //scope: mapobject word zichtbaar.
         map = L.map('map').setView([52.38020147295795, 4.892925143214285], 7);

         //openstreetmap word
        L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
         attribution: 'AET 2025'
         }).addTo(map);

        L.marker([52.38020147295795, 4.892925143214285]).addTo(map)
         .bindPopup('stad van Nederland')
         .openPopup();

         L.marker([35.7198981319163, 139.7351590127453]).addTo(map).bindPopup('Tokyo'); //de coordinatoren vind je terug op google map. click de plek en dan rechter klik.

         L.marker([52.06275232036461, 4.297458493109473]).addTo(map).bindPopup('Den haag');
        }

        function flyToTokyo()
        {
            map.flyTo([35.7198981319163, 139.7351590127453], 15);
        }

        function flyToAmsterdam()
        {
            var amsterdam = [52.3676, 4.9041]; // Latitude, Longitude
             map.flyTo(amsterdam, 15); // 15 = zoom level
        }

        function getStations() {

            $.getJSON("/api/stations", showStations);
        }

// Haal vertrektijden voor één station
async function getDepartures(UICCode) {
    try {
        const response = await fetch(`/api/vertrektijden?station=${UICCode}`);
        const dep = await response.json();
        console.log(dep);
        return dep; // array van vertrektijden
    } catch (err) {
        console.error("Fout bij ophalen vertrektijden:", err);
        return [];
    }
    
}

//de NS API geeft tijden zo: 2026-02-08T21:24:00+01:00. dit maakt ze: 12:23 :
function formatTime(dateString) {
    if (!dateString) return "?";

    const d = new Date(dateString);
    return d.toLocaleTimeString('nl-NL', {
        hour: '2-digit',
        minute: '2-digit'
    });
}


// Stations tekenen op de kaart
function showStations(data) {
    console.log(data);
    for (const st of data) {
        const circle = L.circle([st.lat, st.lng], { radius: 500 })
            .addTo(map)
            .bindPopup(`<strong>${st.name}</strong><br>Klik voor vertrektijden`);

        // Klik op circle → vertrektijden fetchen en popup updaten
        circle.on('click', async () => {
            const dep = await getDepartures(st.UICCode);

            const popupContent = dep.length
                ? dep.slice(0,3).map(t => {
                const time = formatTime(t.actualDateTime || t.plannedDateTime);
                const bestemming = t.recognizableDestination?.name || t.direction;
                const spoor = t.actualTrack || t.plannedTrack || "?";
                return `${time} → ${bestemming} (spoor ${spoor})`;
              }).join("<br>")
                : "Geen vertrektijden beschikbaar";

            circle.bindPopup(`<strong>${st.name}</strong><br>${popupContent}`)
                .openPopup();
        });
    }
}


        /*function showStations(data)
        {
           
            console.log(data);

             const v = 
             then =>
            console.log(vertrektijden); 

            for (var st of data) //var st is per station (var naam kan je veranderen) het gehele data van ns api is "data" dus ook alle stations.
            {

             

            const popup = `
            <div class="station-popup">
            <div class="station-title">${st.namen.lang}</div>
            <div class="tijden"></div>
          `;

          L.circle([st.lat, st.lng], { radius: 500 }).addTo(map).bindPopup(popup);
            
            }
        } */



    </script>
</head>
<body onload="initialize()">


    <h1>landkaart</h1>

    <div id="map"></div>

    <button onclick="flyToTokyo()">Tokyo</button>

    <button onclick="flyToAmsterdam()">Vlieg naar Amsterdam</button>

    <button onclick="getStations()">Treinstations</button>


    
</body>
</html>



